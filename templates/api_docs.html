<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>API Documentation - Generation Service</title>
    <link href="https://cdn.replit.com/agent/bootstrap-agent-dark-theme.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-dark.min.css" rel="stylesheet">
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="/">
                <i class="fas fa-car"></i>
                Generation Service
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="/">Home</a>
                <a class="nav-link active" href="/docs">API Documentation</a>
                <a class="nav-link" href="/health">Health Check</a>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <div class="row">
            <!-- Sidebar -->
            <div class="col-lg-3">
                <div class="card sticky-top">
                    <div class="card-header">
                        <h6 class="card-title mb-0">
                            <i class="fas fa-list"></i>
                            Table of Contents
                        </h6>
                    </div>
                    <div class="card-body p-0">
                        <div class="nav nav-pills flex-column">
                            <a class="nav-link" href="#overview">Overview</a>
                            <a class="nav-link" href="#authentication">Authentication</a>
                            <a class="nav-link" href="#sync-mode">Synchronous Mode</a>
                            <a class="nav-link" href="#batch-mode">Batch Mode</a>
                            <a class="nav-link" href="#polling-api">Polling API</a>
                            <a class="nav-link" href="#webhook">Webhook System</a>
                            <a class="nav-link" href="#examples">Code Examples</a>
                            <a class="nav-link" href="#testing">API Testing</a>
                            <a class="nav-link" href="#limits">Limits & Errors</a>
                            <a class="nav-link" href="#production">Production</a>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Main Content -->
            <div class="col-lg-9">
                <!-- Overview -->
                <section id="overview" class="mb-5">
                    <h2><i class="fas fa-info-circle"></i> Overview</h2>
                    <p class="lead">
                        Production-ready microservice for AI-powered car damage assessment and multilingual description generation 
                        using OpenAI's Vision and Translation models with comprehensive PostgreSQL integration.
                    </p>
                    
                    <div class="alert alert-info">
                        <h6><i class="fas fa-lightbulb"></i> Key Features</h6>
                        <ul class="mb-0">
                            <li><strong>AI Vision Analysis:</strong> OpenAI o4-mini model with maximum accuracy</li>
                            <li><strong>100+ Languages:</strong> Translation using GPT-4.1-mini</li>
                            <li><strong>PostgreSQL Integration:</strong> Persistent job tracking and result storage</li>
                            <li><strong>Background Worker:</strong> Automated monitoring and webhook delivery</li>
                            <li><strong>Polling API:</strong> Real-time status tracking and result retrieval</li>
                            <li><strong>Synchronous Mode:</strong> Single cars (≤300s) with instant results</li>
                            <li><strong>Batch Mode:</strong> Up to 50,000 cars (≤24h) with webhooks</li>
                            <li><strong>Security:</strong> HMAC-SHA256 signature validation</li>
                        </ul>
                    </div>

                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Processing Mode</th>
                                    <th>Trigger</th>
                                    <th>Max Images/Car</th>
                                    <th>Response Time</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td><span class="badge bg-success">Sync</span></td>
                                    <td>1 car in request</td>
                                    <td>≤ 20</td>
                                    <td>≤ 300 seconds</td>
                                </tr>
                                <tr>
                                    <td><span class="badge bg-primary">Batch</span></td>
                                    <td>2+ cars in request</td>
                                    <td>No limit</td>
                                    <td>≤ 24 hours</td>
                                </tr>
                                <tr>
                                    <td><span class="badge bg-info">Polling</span></td>
                                    <td>GET requests for results</td>
                                    <td>N/A</td>
                                    <td>Instant</td>
                                </tr>
                                <tr>
                                    <td><span class="badge bg-warning">Webhook</span></td>
                                    <td>Automatic notifications</td>
                                    <td>N/A</td>
                                    <td>Instant</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </section>

                <!-- Authentication -->
                <section id="authentication" class="mb-5">
                    <h2><i class="fas fa-lock"></i> Authentication</h2>
                    <p>All requests must include a valid HMAC-SHA256 signature for security.</p>
                    
                    <h5>Signature Generation</h5>
                    <pre><code class="language-python">import hmac
import hashlib
import json

def generate_signature(lots, shared_key):
    normalized = json.dumps(lots, separators=(',', ':'), sort_keys=True)
    return hmac.new(shared_key.encode(), normalized.encode(), hashlib.sha256).hexdigest()</code></pre>

                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle"></i>
                        <strong>Security Note:</strong> Invalid signatures result in HTTP 403 Forbidden responses.
                    </div>
                </section>

                <!-- Synchronous Mode -->
                <section id="sync-mode" class="mb-5">
                    <h2><i class="fas fa-zap"></i> Synchronous Mode</h2>
                    <p>For single car processing with immediate response (≤300 seconds).</p>

                    <h5>Request Format</h5>
                    <div class="card bg-dark">
                        <div class="card-header">
                            <code>POST /api/v1/generate-descriptions</code>
                        </div>
                        <div class="card-body">
                            <pre><code class="language-json">{
  "signature": "hmac_sha256_signature_here",
  "version": "1.0.0",
  "languages": ["en", "ru", "fr"],
  "lots": [
    {
      "lot_id": "11-12345",
      "additional_info": "2019 Toyota Camry, front collision damage",
      "images": [
        {"url": "https://example.com/car1.jpg"},
        {"url": "https://example.com/car2.jpg"}
      ]
    }
  ]
}</code></pre>
                        </div>
                    </div>

                    <h5 class="mt-4">Success Response (200 OK)</h5>
                    <div class="card bg-dark">
                        <div class="card-body">
                            <pre><code class="language-json">{
  "version": "1.0.0",
  "lots": [
    {
      "lot_id": "11-12345",
      "descriptions": [
        {
          "language": "en",
          "damages": "<p>Front-end collision damage visible...</p>"
        },
        {
          "language": "ru", 
          "damages": "<p>Повреждения от лобового столкновения...</p>"
        }
      ],
      "missing_images": ["https://example.com/unreachable.jpg"]
    }
  ]
}</code></pre>
                        </div>
                    </div>
                </section>

                <!-- Batch Mode -->
                <section id="batch-mode" class="mb-5">
                    <h2><i class="fas fa-layer-group"></i> Batch Mode</h2>
                    <p>For processing multiple cars (2-50,000) with webhook notifications.</p>

                    <h5>Request Format</h5>
                    <div class="card bg-dark">
                        <div class="card-header">
                            <code>POST /api/v1/generate-descriptions</code>
                        </div>
                        <div class="card-body">
                            <pre><code class="language-json">{
  "signature": "hmac_sha256_signature_here",
  "version": "1.0.0", 
  "languages": ["en", "de"],
  "lots": [
    {
      "webhook": "https://your-app.com/webhook",
      "lot_id": "batch-001",
      "additional_info": "BMW X5 damage assessment",
      "images": [{"url": "https://example.com/bmw1.jpg"}]
    },
    {
      "webhook": "https://your-app.com/webhook",
      "lot_id": "batch-002", 
      "additional_info": "Mercedes C-Class inspection",
      "images": [{"url": "https://example.com/merc1.jpg"}]
    }
  ]
}</code></pre>
                        </div>
                    </div>

                    <h5 class="mt-4">Accepted Response (201)</h5>
                    <div class="card bg-dark">
                        <div class="card-body">
                            <pre><code class="language-json">{
  "job_id": "550e8400-e29b-41d4-a716-446655440000",
  "status": "accepted",
  "created_at": "2025-08-05T07:30:00Z",
  "total_lots": 2,
  "languages": ["en", "de"],
  "estimated_completion": "2025-08-05T08:30:00Z"
}</code></pre>
                        </div>
                    </div>

                    <div class="alert alert-success mt-4">
                        <h6><i class="fas fa-info-circle"></i> Batch Job Statuses</h6>
                        <div class="row">
                            <div class="col-md-6">
                                <ul class="mb-0">
                                    <li><span class="badge bg-secondary">pending</span> - Queued for processing</li>
                                    <li><span class="badge bg-primary">processing</span> - OpenAI vision analysis</li>
                                    <li><span class="badge bg-info">translating</span> - Multi-language translation</li>
                                </ul>
                            </div>
                            <div class="col-md-6">
                                <ul class="mb-0">
                                    <li><span class="badge bg-success">completed</span> - All results ready</li>
                                    <li><span class="badge bg-danger">failed</span> - Processing error</li>
                                    <li><span class="badge bg-warning">cancelled</span> - User cancelled</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Polling API -->
                <section id="polling-api" class="mb-5">
                    <h2><i class="fas fa-search"></i> Polling API - Job Tracking</h2>
                    <p>Real-time job status monitoring and result retrieval system.</p>

                    <h5>Job Status Check</h5>
                    <div class="card bg-dark">
                        <div class="card-header">
                            <code>GET /api/v1/batch-status/{job_id}</code>
                        </div>
                        <div class="card-body">
                            <p class="text-info">Headers: <code>X-Signature: sha256=your_hmac_signature</code></p>
                            <pre><code class="language-json">{
  "job_id": "550e8400-e29b-41d4-a716-446655440000",
  "status": "processing",
  "created_at": "2025-08-05T07:30:00Z",
  "updated_at": "2025-08-05T07:35:00Z",
  "progress": {
    "total_lots": 100,
    "processed_lots": 45,
    "failed_lots": 2,
    "completion_percentage": 45.0
  },
  "languages": ["en", "ru", "de"],
  "openai_vision_batch_id": "batch_67890abc"
}</code></pre>
                        </div>
                    </div>

                    <h5 class="mt-4">Get Results</h5>
                    <div class="card bg-dark">
                        <div class="card-header">
                            <code>GET /api/v1/batch-results/{job_id}</code>
                        </div>
                        <div class="card-body">
                            <pre><code class="language-json">{
  "job_id": "550e8400-e29b-41d4-a716-446655440000",
  "status": "completed",
  "completed_at": "2025-08-05T08:15:00Z",
  "results": {
    "total_lots": 2,
    "processed_lots": 2,
    "lots": [
      {
        "lot_id": "batch-001",
        "status": "completed",
        "descriptions": [...]
      }
    ]
  }
}</code></pre>
                        </div>
                    </div>

                    <h5 class="mt-4">Additional Endpoints</h5>
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Endpoint</th>
                                    <th>Method</th>
                                    <th>Description</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td><code>/api/v1/batch-results/{id}/download</code></td>
                                    <td><span class="badge bg-info">GET</span></td>
                                    <td>Download results as JSON file</td>
                                </tr>
                                <tr>
                                    <td><code>/api/v1/batch-jobs</code></td>
                                    <td><span class="badge bg-info">GET</span></td>
                                    <td>List all jobs with filtering</td>
                                </tr>
                                <tr>
                                    <td><code>/api/v1/batch-jobs/{id}/cancel</code></td>
                                    <td><span class="badge bg-warning">POST</span></td>
                                    <td>Cancel pending/processing job</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </section>

                <!-- Webhook -->
                <section id="webhook" class="mb-5">
                    <h2><i class="fas fa-bell"></i> Webhook System</h2>
                    <p>Production-ready webhook system with automatic retries and reliable delivery via Background Worker.</p>

                    <h5>Webhook Payload</h5>
                    <div class="card bg-dark">
                        <div class="card-header">
                            <code>POST {your_webhook_url}</code>
                        </div>
                        <div class="card-body">
                            <pre><code class="language-json">{
  "signature": "hmac_sha256_signature_here",
  "version": "1.0.0",
  "lots": [
    {
      "lot_id": "batch-001",
      "descriptions": [
        {
          "language": "en",
          "damages": "<p>Detailed damage assessment...</p>"
        },
        {
          "language": "de", 
          "damages": "<p>Detaillierte Schadensbewertung...</p>"
        }
      ],
      "missing_images": []
    }
  ]
}</code></pre>
                        </div>
                    </div>

                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i>
                        <strong>Advanced Retry Policy:</strong> Background Worker automatically handles failed deliveries with up to 5 attempts using exponential backoff (30s → 240s). All delivery attempts are tracked in PostgreSQL.
                    </div>

                    <h5 class="mt-4">Webhook Verification</h5>
                    <div class="card bg-dark">
                        <div class="card-body">
                            <pre><code class="language-python">import hmac
import hashlib

def verify_webhook_signature(payload_json, received_signature, shared_key):
    expected_signature = hmac.new(
        shared_key.encode(),
        payload_json.encode(), 
        hashlib.sha256
    ).hexdigest()
    return f"sha256={expected_signature}" == received_signature</code></pre>
                        </div>
                    </div>
                </section>

                <!-- Examples -->
                <section id="examples" class="mb-5">
                    <h2><i class="fas fa-code"></i> Code Examples</h2>

                    <h5>Python Example</h5>
                    <div class="card bg-dark">
                        <div class="card-body">
                            <pre><code class="language-python">import requests
import hmac
import hashlib
import json

def generate_signature(lots, shared_key):
    normalized = json.dumps(lots, separators=(',', ':'), sort_keys=True)
    return hmac.new(shared_key.encode(), normalized.encode(), hashlib.sha256).hexdigest()

# Single car (sync mode)
lots = [{
    "lot_id": "test-001",
    "additional_info": "Test car damage assessment",
    "images": [{"url": "https://example.com/car.jpg"}]
}]

payload = {
    "signature": generate_signature(lots, "your-shared-key"),
    "version": "1.0.0",
    "languages": ["en", "es"],
    "lots": lots
}

response = requests.post(
    "http://localhost:5000/api/v1/generate-descriptions",
    json=payload,
    headers={"Content-Type": "application/json"}
)

print(f"Status: {response.status_code}")
print(f"Response: {response.json()}")</code></pre>
                        </div>
                    </div>

                    <h5 class="mt-4">cURL Example</h5>
                    <div class="card bg-dark">
                        <div class="card-body">
                            <pre><code class="language-bash">curl -X POST http://localhost:5000/api/v1/generate-descriptions \
  -H "Content-Type: application/json" \
  -d '{
    "signature": "your_hmac_signature_here",
    "version": "1.0.0",
    "languages": ["en", "fr"],
    "lots": [{
      "lot_id": "curl-test-001",
      "additional_info": "Testing via cURL",
      "images": [{"url": "https://example.com/test-car.jpg"}]
    }]
  }'</code></pre>
                        </div>
                    </div>
                </section>

                <!-- API Testing -->
                <section id="testing" class="mb-5">
                    <h2><i class="fas fa-play"></i> API Testing</h2>
                    <p>Test the API endpoints interactively using the form below.</p>

                    <div class="card">
                        <div class="card-header">
                            <h6 class="card-title mb-0">
                                <i class="fas fa-vial"></i>
                                Image Validation Test
                            </h6>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label for="imageUrls" class="form-label">Image URLs (one per line)</label>
                                <textarea class="form-control" id="imageUrls" rows="5" 
                                    placeholder="https://example.com/car1.jpg&#10;https://example.com/car2.jpg"></textarea>
                            </div>
                            <button type="button" class="btn btn-primary" onclick="testImageValidation()">
                                <i class="fas fa-check"></i>
                                Test Image Validation
                            </button>
                            <div id="validationResult" class="mt-3"></div>
                        </div>
                    </div>

                    <div class="card mt-4">
                        <div class="card-header">
                            <h6 class="card-title mb-0">
                                <i class="fas fa-heartbeat"></i>
                                Service Health Check
                            </h6>
                        </div>
                        <div class="card-body">
                            <button type="button" class="btn btn-info" onclick="checkHealth()">
                                <i class="fas fa-heartbeat"></i>
                                Check Service Health
                            </button>
                            <div id="healthResult" class="mt-3"></div>
                        </div>
                    </div>
                </section>

                <!-- Limits & Errors -->
                <section id="limits" class="mb-5">
                    <h2><i class="fas fa-exclamation-triangle"></i> Limits & Error Codes</h2>

                    <h5>Processing Limits</h5>
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Limit Type</th>
                                    <th>Sync Mode</th>
                                    <th>Batch Mode</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>Max images per car</td>
                                    <td>20</td>
                                    <td>No limit</td>
                                </tr>
                                <tr>
                                    <td>Max cars per request</td>
                                    <td>1</td>
                                    <td>50,000</td>
                                </tr>
                                <tr>
                                    <td>Max image size</td>
                                    <td colspan="2">10 MB</td>
                                </tr>
                                <tr>
                                    <td>Max batch file size</td>
                                    <td>N/A</td>
                                    <td>200 MB</td>
                                </tr>
                                <tr>
                                    <td>Response timeout</td>
                                    <td>300 seconds</td>
                                    <td>24 hours</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <h5 class="mt-4">HTTP Status Codes</h5>
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Status Code</th>
                                    <th>Description</th>
                                    <th>Common Causes</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td><span class="badge bg-success">200</span></td>
                                    <td>OK - Sync processing completed</td>
                                    <td>Single car processed successfully</td>
                                </tr>
                                <tr>
                                    <td><span class="badge bg-primary">201</span></td>
                                    <td>Accepted - Batch job created</td>
                                    <td>Multiple cars submitted for batch processing</td>
                                </tr>
                                <tr>
                                    <td><span class="badge bg-warning">400</span></td>
                                    <td>Bad Request</td>
                                    <td>Invalid JSON, missing fields, limit exceeded</td>
                                </tr>
                                <tr>
                                    <td><span class="badge bg-danger">403</span></td>
                                    <td>Forbidden</td>
                                    <td>Invalid HMAC signature</td>
                                </tr>
                                <tr>
                                    <td><span class="badge bg-secondary">404</span></td>
                                    <td>Not Found</td>
                                    <td>Batch job ID not found</td>
                                </tr>
                                <tr>
                                    <td><span class="badge bg-danger">500</span></td>
                                    <td>Internal Server Error</td>
                                    <td>OpenAI API failure, processing error</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </section>

                <!-- Production -->
                <section id="production" class="mb-5">
                    <h2><i class="fas fa-server"></i> Production Deployment</h2>
                    <p>Ready for production deployment with PostgreSQL, Background Worker, and comprehensive monitoring.</p>

                    <h5>Environment Variables</h5>
                    <div class="card bg-dark">
                        <div class="card-body">
                            <pre><code class="language-bash"># Required
export DATABASE_URL="postgresql://user:password@host:5432/database"
export OPENAI_API_KEY="sk-your-openai-api-key"
export SHARED_KEY="your-secret-hmac-key-minimum-32-chars"

# Optional
export SESSION_SECRET="your-session-secret-key"
export LOG_LEVEL="INFO"</code></pre>
                        </div>
                    </div>

                    <h5 class="mt-4">System Architecture</h5>
                    <div class="alert alert-success">
                        <h6><i class="fas fa-check-circle"></i> Production Components</h6>
                        <div class="row">
                            <div class="col-md-6">
                                <ul class="mb-0">
                                    <li><strong>Flask App:</strong> Main API with Gunicorn</li>
                                    <li><strong>PostgreSQL:</strong> Persistent job storage</li>
                                    <li><strong>Background Worker:</strong> Automated monitoring</li>
                                </ul>
                            </div>
                            <div class="col-md-6">
                                <ul class="mb-0">
                                    <li><strong>OpenAI Integration:</strong> Vision & Translation</li>
                                    <li><strong>Webhook Delivery:</strong> Reliable notifications</li>
                                    <li><strong>Load Balancer:</strong> nginx/HAProxy ready</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </section>
            </div>
        </div>
    </div>

    <footer class="bg-dark text-center py-4 mt-5">
        <div class="container">
            <p class="text-muted mb-0">
                &copy; 2025 Generation Service - Production-Ready AI Car Description API<br>
                <strong>Version 2.0</strong> | PostgreSQL Integration | Background Worker | Polling API
            </p>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script src="/static/js/api_test.js"></script>
</body>
</html>
